# TLS Certificates

Run the API over HTTPS with a trusted TLS certificate.

## Overview

- **Local development** — use [mkcert](https://github.com/FiloSottile/mkcert) to create locally-trusted certificates in seconds
- **Production** — use certificates from a real CA (Let's Encrypt, your organization's CA, etc.)
- Kestrel loads the certificate from `appsettings.Production.json` automatically

## Local Development with mkcert

### Step 1: Install mkcert

**Recommended — download from GitHub releases (all platforms):**

Download the latest binary for your OS from [mkcert releases](https://github.com/FiloSottile/mkcert/releases), rename it to `mkcert` (or `mkcert.exe` on Windows), and place it somewhere on your `PATH`.

**Alternative — using a package manager:**

```powershell
# Windows (Chocolatey)
choco install mkcert

# Windows (Scoop)
scoop bucket add extras
scoop install mkcert

# macOS
brew install mkcert

# Linux (Debian/Ubuntu — install libnss3-tools first for Firefox support)
sudo apt install libnss3-tools
brew install mkcert
```

### Step 2: Install the Local CA

Run this once per machine to install the mkcert root CA into your system trust store:

```bash
mkcert -install
```

> **Note**: This makes all certificates generated by mkcert trusted on your machine. Browsers and HTTP clients will accept them without warnings.

### Step 3: Generate the Certificate

Navigate to the project's config directory and generate a `.pfx` certificate:

```powershell
cd DBToRestAPI/config
mkdir certs
mkcert -pkcs12 -p12-file certs/certificate.pfx localhost 127.0.0.1 ::1
```

This creates a PKCS#12 certificate valid for `localhost`, `127.0.0.1`, and `::1` (IPv6 loopback). The default password is `changeit`.

> **Tip**: Add additional hostnames or IPs if you need to access the API from other machines on your network:
> ```bash
> mkcert -pkcs12 -p12-file certs/certificate.pfx localhost 127.0.0.1 ::1 mydevbox.local 192.168.1.50
> ```

### Step 4: Configure Kestrel

Add (or verify) the following in `appsettings.Production.json`:

```json
{
  "Kestrel": {
    "Endpoints": {
      "Http": {
        "Url": "http://*:5000"
      },
      "Https": {
        "Url": "https://*:5001",
        "Certificate": {
          "Path": "config/certs/certificate.pfx",
          "Password": "changeit"
        }
      }
    }
  }
}
```

The certificate path is relative to the application's working directory.

### Step 5: Run the Application

```bash
dotnet run --environment Production
```

The API is now available at `https://localhost:5001`.

## Production Certificates

For real production deployments, replace the mkcert certificate with one from a trusted CA.

### Option 1: Let's Encrypt (free, automated)

Use [Certbot](https://certbot.eff.org/) or a similar ACME client to obtain a certificate, then convert it to `.pfx`:

```bash
openssl pkcs12 -export \
  -out certificate.pfx \
  -inkey privkey.pem \
  -in fullchain.pem \
  -password pass:YourStrongPassword
```

Update `appsettings.Production.json` with the new password.

### Option 2: Reverse Proxy (recommended for production)

In most production setups, a reverse proxy (Nginx, Caddy, Azure App Service, AWS ALB) handles TLS termination and forwards plain HTTP to Kestrel. In that case, you only need the `Http` endpoint:

```json
{
  "Kestrel": {
    "Endpoints": {
      "Http": {
        "Url": "http://*:5000"
      }
    }
  }
}
```

The reverse proxy handles certificates, renewal, and HTTPS.

## Security Notes

- **Never commit certificates** to source control. Add `**/certs/` to your `.gitignore`.
- **Never use `changeit` as a password in production.** Use environment variables or [Settings Encryption](15-encryption.md) to protect the certificate password:
  ```json
  "Password": "${CERT_PASSWORD}"
  ```
- **mkcert certificates are for development only.** They are signed by a local CA that is only trusted on your machine.

## Troubleshooting

| Problem | Solution |
|---------|----------|
| Browser shows "Not Secure" | Run `mkcert -install` to trust the local CA |
| `ERR_CERT_AUTHORITY_INVALID` | The mkcert root CA isn't installed — re-run `mkcert -install` |
| `The certificate path was not found` | Verify the `Path` in `appsettings.Production.json` is correct relative to the working directory |
| `The specified password is incorrect` | Ensure `Password` matches what was used during certificate generation (mkcert default: `changeit`) |
| Certificate expired | mkcert certificates last ~2 years — regenerate with the same command |
